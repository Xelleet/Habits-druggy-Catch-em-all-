<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .progress-bar {
   width: 100%;
   height: 20px;
   background: #e0e0e0;
   border-radius: 10px;
   overflow: hidden;
   margin: 8px 0;
}
.progress {
   height: 100%;
   background: #4CAF50;
   transition: width 0.5s ease;
}
.notification {
   position: fixed;
   top: 20px;
   right: 20px;
   background: #4CAF50;
   color: white;
   padding: 12px 20px;
   border-radius: 6px;
   box-shadow: 0 4px 12px rgba(0,0,0,0.15);
   z-index: 1000;
   animation: slideIn 0.3s, fadeOut 0.5s 2.5s forwards;
}
@keyframes slideIn {
   from { transform: translateX(100%); opacity: 0; }
   to { transform: translateX(0); opacity: 1; }
}
@keyframes fadeOut {
   to { opacity: 0; transform: translateX(100%); }
}

    </style>
    <script>
        const csrfToken = '{{ csrf_token }}';

    </script>
</head>
<body>
    <h1>Профиль</h1>
    <p>Твой XP: <strong>{{total_xp}}</strong></p>
    <a href="/admin/">Вернуться в админку</a>
    <h2>Твои привычки</h2>
    <p><a href="{% url 'habits:create_habit' %}":>Добавить привычку</a></p>
    <ul>
        {% for habit in habits %}
            <li>{{habit.name}} ({{habit.xp_reward}}XP) | Level: <strong>{{level}}</strong></li>
        {% empty %}
            <li>У тебя пока нет привычек</li>
        {% endfor %}
    </ul>
    <div class="level-box">
    <p id="level-display">Уровень: <strong>{{ level }}</strong></p>
    <p id="xp-display">XP: {{ total_xp }} / {{ xp_for_next_level }}</p>
    <div class="progress-bar">
        <div class="progress" id="progress-bar" style="width: {{ progress_percent }}%"></div>
    </div>
    <p id="xp-needed">
        {% if xp_needed > 0 %}
            Ещё {{ xp_needed }} XP до уровня {{ level|add:"1" }}
        {% else %}
            Поздравляем! Ты достиг максимума (пока)!
        {% endif %}
    </p>
</div>

    <h2>Статистика по привычкам</h2>
    {% for habit in habits_with_stats %}
        <strong>{{habit.name}}</strong>
    {% if habit.description %}<br><em>{{habit.description}}</em> {%endif%}
    <br>Выполнено: <strong>{{habit.completion_count}}</strong> раз
    <strong>{{habit.total_xp_from_habit}}</strong>XP
    <a href="{% url 'habits:complete_habit' habit.id %}">  Выполнить сегодня</a>
        <a href="{% url 'habits:delete_habit' habit.id %}" onclick="return confirm('Точно удалить?')">  Удалить</a>
    {% endfor %}
    <h3>Твои награды: </h3>
    <ul>
        {% for ub in badges %}
            <li>{{ub.badge.name}} - {{ub.awarded_at|date:"d.m.Y"}}</li>
        {% empty %}
            <li>Нет наград</li>
        {% endfor %}
    </ul>
<script>
function showNotification(text, type = 'success') {
    const notif = document.createElement('div');
    notif.className = 'notification';
    notif.style.background = type === 'success' ? '#4CAF50' : '#2196F3';
    notif.textContent = text;
    document.body.appendChild(notif);
    setTimeout(() => {
        if (notif.parentNode) notif.remove();
    }, 3000);
}

// AJAX для кнопок "Выполнить сегодня"
document.querySelectorAll('a[href*="/complete/"]').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const url = this.href;

        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Обновляем XP
                document.getElementById('xp-display').textContent = `XP: ${data.total_xp} / ${data.xp_for_next_level}`;

                // Обновляем уровень
                document.getElementById('level-display').innerHTML = `Уровень: <strong>${data.level}</strong>`;

                // Обновляем прогресс-бар
                const progressPercent = (data.total_xp / data.xp_for_next_level) * 100;
                document.getElementById('progress-bar').style.width = `${Math.min(100, progressPercent)}%`;

                // Обновляем текст о недостающем XP
                const xpNeededEl = document.getElementById('xp-needed');
                if (data.xp_needed > 0) {
                    xpNeededEl.textContent = `Ещё ${data.xp_needed} XP до уровня ${data.level + 1}`;
                } else {
                    xpNeededEl.textContent = 'Поздравляем! Ты достиг максимума (пока)!';
                }

                // Показ уведомлений
                showNotification(`+${data.xp_gained} XP!`, 'success');
                if (data.level_up) {
                    showNotification(`Новый уровень: ${data.new_level}!`, 'success');
                }
            } else {
                showNotification(data.message || 'Что-то пошло не так.', 'error');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showNotification('Не удалось обновить привычку.', 'error');
        });
    });
});
</script>
</body>
</html>